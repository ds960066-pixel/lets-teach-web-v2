<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Institute Dashboard | Lets Teach</title>

  <style>
    body{
      font-family: Arial;
      background:#f4f4f4;
      padding:20px;
      margin:0;
    }
    .wrap{max-width:1100px;margin:auto}
    h2{margin:10px 0 6px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .muted{color:#555;font-size:13px}
    .row{display:flex;gap:12px;flex-wrap:wrap}

    .card{
      background:#fff;
      padding:15px;
      margin:12px 0;
      border-radius:10px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.06);
    }

    button{
      padding:8px 12px;
      background:#2e86de;
      color:#fff;
      border:none;
      cursor:pointer;
      border-radius:8px;
      font-weight:600;
    }
    button:hover{filter:brightness(.96)}
    button:disabled{opacity:.6;cursor:not-allowed}

    .btnDanger{background:#dc2626}
    .btnGhost{
      background:transparent;
      color:#2e86de;
      border:1px solid rgba(46,134,222,.35);
    }

    a{color:#2e86de}
    input, textarea, select{
      padding:10px;
      border-radius:8px;
      border:1px solid #ddd;
      width:100%;
      outline:none;
      background:#fff;
    }
    textarea{min-height:90px;resize:vertical}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}

    .resume{
      background:#f8f9fa;
      padding:10px;
      margin-top:10px;
      border-radius:8px;
      border:1px solid rgba(0,0,0,.06);
    }

    .badge{
      display:inline-block;
      padding:5px 10px;
      border-radius:999px;
      font-size:12px;
      background:#eef6ff;
      color:#1e40af;
      border:1px solid rgba(30,64,175,.15);
    }
    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      background:#ecfdf5;
      color:#065f46;
      border:1px solid rgba(6,95,70,.18);
      margin-left:8px;
    }
    .hr{border:0;border-top:1px solid #eee;margin:12px 0}
    .mini{font-size:12px;color:#666}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .twoCols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:800px){.twoCols{grid-template-columns:1fr}}
  </style>
</head>

<body>
<div class="wrap">

<script>
/* ================= AUTH + ROLE GUARD ================= */
if (!localStorage.uid || localStorage.role !== "institute") {
  window.location.href = "login.html";
}
</script>

<div class="topbar">
  <div>
    <h2>Institute Dashboard</h2>
    <div class="muted">UID: <b id="uidText"></b></div>
  </div>
  <button class="btnDanger" onclick="logout()">Logout</button>
</div>

<!-- ================== JOB POST SECTION (NEW) ================== -->
<div class="card">
  <h3 style="margin:0 0 6px;">üìå Post a Job</h3>
  <div class="muted">
    Note: ‚ÄúSubjects Needed‚Äù profile ‚â† Job. Job yahan post karoge tabhi Jobs page me show hoga.
  </div>
  <div class="hr"></div>

  <div class="twoCols">
    <div>
      <label class="mini">Job Title *</label>
      <input id="jobTitle" placeholder="e.g. English Teacher (Class 6-10)" />
    </div>
    <div>
      <label class="mini">Subject *</label>
      <input id="jobSubject" placeholder="e.g. English" />
    </div>

    <div>
      <label class="mini">City *</label>
      <input id="jobCity" placeholder="e.g. Patna" />
    </div>

    <div>
      <label class="mini">Role</label>
      <select id="jobRole">
        <option value="both">Both</option>
        <option value="part-time">Part-time</option>
        <option value="full-time">Full-time</option>
      </select>
    </div>
  </div>

  <div style="margin-top:12px;">
    <label class="mini">Salary (optional)</label>
    <input id="jobSalary" placeholder="e.g. 20,000 - 30,000 / month" />
  </div>

  <div style="margin-top:12px;">
    <label class="mini">Description (optional)</label>
    <textarea id="jobDesc" placeholder="Job details, timing, class, requirement..."></textarea>
  </div>

  <div class="actions">
    <button onclick="createJob()">Create Job</button>
    <button class="btnGhost" onclick="clearJobForm()">Clear</button>
    <span id="jobMsg" class="muted"></span>
  </div>
</div>

<div class="card">
  <div class="row" style="align-items:center;justify-content:space-between;">
    <h3 style="margin:0;">üßæ My Jobs</h3>
    <button onclick="loadMyJobs()">Refresh Jobs</button>
  </div>
  <div id="myJobs" class="muted" style="margin-top:10px;">Loading...</div>
</div>

<!-- ================== EXISTING SECTIONS ================== -->
<div class="grid2">

  <div class="card">
    <div class="row" style="align-items:center;justify-content:space-between;">
      <h3 style="margin:0;">Browse Teachers</h3>
      <button onclick="browseTeachers()">Load Teachers</button>
    </div>
    <div id="teachers" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <div class="row" style="align-items:center;justify-content:space-between;">
      <h3 style="margin:0;">Job Applications</h3>
      <button onclick="loadApplications()">View Applications</button>
    </div>
    <div id="applications" style="margin-top:10px;"></div>
  </div>

</div>

</div> <!-- wrap -->

<script>
const BASE_URL = "https://express-hello-world-uh96.onrender.com";
const uid = localStorage.getItem("uid");
document.getElementById("uidText").innerText = uid;

/* ================= LOGOUT ================= */
function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}

/* ================= HELPER: BUILD RESUME LINK ================= */
function buildResumeLink(resumeUrl) {
  if (!resumeUrl) return null;
  if (resumeUrl.startsWith("http")) return resumeUrl;
  if (resumeUrl.startsWith("/")) return `${BASE_URL}${resumeUrl}`;
  return `${BASE_URL}/${resumeUrl}`;
}

/* ================= JOB: CREATE ================= */
async function createJob() {
  const title = document.getElementById("jobTitle").value.trim();
  const subject = document.getElementById("jobSubject").value.trim();
  const city = document.getElementById("jobCity").value.trim();
  const role = document.getElementById("jobRole").value;
  const salary = document.getElementById("jobSalary").value.trim();
  const description = document.getElementById("jobDesc").value.trim();
  const msg = document.getElementById("jobMsg");

  msg.innerText = "";

  if (!title || !subject || !city) {
    msg.innerText = "‚ùå Title, Subject, City required.";
    return;
  }

  try {
    const res = await fetch(`${BASE_URL}/api/job/create`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        instituteUid: uid,
        title,
        subject,
        city,
        role,
        salary,
        description
      })
    });

    const data = await res.json();

    if (!res.ok || data.success === false) {
      msg.innerText = "‚ùå " + (data.message || "Job create failed");
      return;
    }

    msg.innerText = "‚úÖ Job created successfully";
    clearJobForm(false);
    loadMyJobs();
  } catch (e) {
    console.error(e);
    msg.innerText = "‚ùå Server error while creating job";
  }
}

function clearJobForm(clearMsg = true) {
  document.getElementById("jobTitle").value = "";
  document.getElementById("jobSubject").value = "";
  document.getElementById("jobCity").value = "";
  document.getElementById("jobRole").value = "both";
  document.getElementById("jobSalary").value = "";
  document.getElementById("jobDesc").value = "";
  if (clearMsg) document.getElementById("jobMsg").innerText = "";
}

/* ================= JOB: MY JOBS LIST ================= */
/* Backend expected: GET /api/job/institute/:uid */
async function loadMyJobs() {
  const box = document.getElementById("myJobs");
  box.innerHTML = `<div class="muted">Loading...</div>`;

  try {
    const res = await fetch(`${BASE_URL}/api/job/institute/${uid}`);
    const data = await res.json();

    const jobs = data.jobs || [];
    if (!jobs.length) {
      box.innerHTML = `<div class="muted">No jobs posted yet.</div>`;
      return;
    }

    box.innerHTML = "";
    jobs.forEach(j => {
      const div = document.createElement("div");
      div.className = "card";
      div.style.margin = "10px 0";
      div.style.padding = "12px";

      const status = j.status || "open";
      const badge = status === "open"
        ? `<span class="pill">OPEN</span>`
        : `<span class="pill" style="background:#fef2f2;color:#991b1b;border-color:rgba(153,27,27,.18)">CLOSED</span>`;

      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div>
            <b>${escapeHtml(j.title || "Job")}</b> ${badge}<br>
            <span class="muted">${escapeHtml(j.subject || "‚Äî")} ¬∑ ${escapeHtml(j.city || "‚Äî")} ¬∑ ${escapeHtml(j.role || "both")}</span><br>
            <span class="mini">Salary: ${escapeHtml(j.salary || "Negotiable")}</span><br>
            <span class="mini">Job ID: <code>${escapeHtml(j._id || "")}</code></span>
          </div>

          <div class="actions">
            <button class="btnGhost" onclick="copyText('${j._id || ""}')">Copy ID</button>
            ${
              status === "open"
                ? `<button class="btnDanger" onclick="closeJob('${j._id || ""}')">Close Job</button>`
                : ``
            }
          </div>
        </div>
      `;

      box.appendChild(div);
    });
  } catch (e) {
    console.error(e);
    box.innerHTML = `<div class="muted">Failed to load jobs</div>`;
  }
}

/* Close job */
async function closeJob(jobId) {
  if (!jobId) return;

  const ok = confirm("Close this job? (It will not appear in public jobs.)");
  if (!ok) return;

  try {
    const res = await fetch(`${BASE_URL}/api/job/close/${jobId}`, { method: "POST" });
    const data = await res.json();
    if (!res.ok || data.success === false) {
      alert(data.message || "Close failed");
      return;
    }
    alert("‚úÖ Job closed");
    loadMyJobs();
  } catch (e) {
    console.error(e);
    alert("Server error while closing job");
  }
}

/* ================= BROWSE TEACHERS ================= */
async function browseTeachers() {
  try {
    const res = await fetch(`${BASE_URL}/api/teacher/browse`);
    const data = await res.json();

    const box = document.getElementById("teachers");
    box.innerHTML = "";

    if (!data.teachers || data.teachers.length === 0) {
      box.innerHTML = "<p class='muted'>No teachers found</p>";
      return;
    }

    data.teachers.forEach(t => {
      const div = document.createElement("div");
      div.className = "card";

      div.innerHTML = `
        <b>${escapeHtml(t.name)}</b> ‚Äì ${escapeHtml(t.subject)} (${escapeHtml(t.city || "")})<br>
        <a href="teacher-resume-view.html?uid=${encodeURIComponent(t.uid)}" target="_blank">
          View Resume Page
        </a>
        <br><br>
        <button onclick="sendInvite('${t.uid}')">Send Invite</button>
      `;

      box.appendChild(div);
    });
  } catch (e) {
    console.error(e);
    alert("Failed to load teachers");
  }
}

/* ================= SEND INVITE ================= */
async function sendInvite(teacherUid) {
  try {
    const res = await fetch(`${BASE_URL}/api/invite/create`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        fromType: "institute",
        fromUid: uid,
        toType: "teacher",
        toUid: teacherUid
      })
    });

    const data = await res.json();
    alert(data.message || "Invite sent");
  } catch (e) {
    console.error(e);
    alert("Invite failed");
  }
}

/* ================= LOAD JOB APPLICATIONS ================= */
async function loadApplications() {
  try {
    const res = await fetch(`${BASE_URL}/api/job/applications/institute/${uid}`);
    const data = await res.json();

    const box = document.getElementById("applications");
    box.innerHTML = "";

    if (!data.applications || data.applications.length === 0) {
      box.innerHTML = "<p class='muted'>No applications yet</p>";
      return;
    }

    data.applications.forEach(app => {
      const div = document.createElement("div");
      div.className = "card";

      const snap = app.resumeSnapshot || {};
      const t = app.teacher || {};
      const resumePdf = t.resumeUrl ? buildResumeLink(t.resumeUrl) : null;

      const education = snap.education || t.education || "‚Äî";
      const skillsArr = (snap.skills && snap.skills.length) ? snap.skills : (t.skills || []);
      const skills = skillsArr.length ? skillsArr.join(", ") : "‚Äî";
      const about = snap.about || t.about || "‚Äî";
      const status = app.status || "pending";

      div.innerHTML = `
        <b>Teacher:</b> ${t.name ? `${escapeHtml(t.name)} (${escapeHtml(app.teacherUid)})` : escapeHtml(app.teacherUid)}<br>
        <b>Status:</b> ${escapeHtml(status)}<br>

        <div class="resume">
          <b>Education:</b> ${escapeHtml(education)}<br>
          <b>Skills:</b> ${escapeHtml(skills)}<br>
          <b>About:</b> ${escapeHtml(about)}
          <br><br>

          ${
            resumePdf
              ? `‚úÖ <b>Resume PDF:</b>
                 <a href="${resumePdf}" target="_blank">View</a>
                 |
                 <a href="${resumePdf}" download>Download</a>`
              : `‚ùå <b>Resume PDF:</b> Not uploaded`
          }
        </div>

        ${
          (status === "pending" || status === "applied")
            ? `<br><button onclick="shortlist('${app._id}')">Shortlist</button>`
            : ""
        }
      `;

      box.appendChild(div);
    });
  } catch (e) {
    console.error(e);
    alert("Failed to load applications");
  }
}

/* ================= SHORTLIST ================= */
async function shortlist(id) {
  await fetch(`${BASE_URL}/api/job/application/shortlist/${id}`, { method: "POST" });
  alert("Applicant shortlisted");
  loadApplications();
}

/* ================= HELPERS ================= */
function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function copyText(txt) {
  if (!txt) return;
  navigator.clipboard.writeText(txt).then(() => alert("Copied ‚úÖ"));
}

/* INIT */
loadMyJobs();
</script>
</body>
</html>
