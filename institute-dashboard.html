<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Institute Dashboard | Lets Teach</title>

  <!-- ‚úÖ Same Professional Theme -->
  <link rel="stylesheet" href="styles.css" />
</head>

<body>

  <!-- AUTH + ROLE GUARD -->
  <script>
    if (!localStorage.uid || localStorage.role !== "institute") {
      window.location.href = "login.html";
    }
  </script>

  <!-- NAV -->
  <div class="nav">
    <div class="container navInner">
      <a class="brand" href="index.html">
        <div class="logo"></div>
        <div>Lets Teach</div>
      </a>

      <div class="navLinks">
        <a class="pill" href="jobs.html">Jobs</a>
        <a class="pill" href="interview/index.html">Interview Preps</a>
        <a class="pill" href="#" onclick="logout();return false;">Logout</a>
      </div>
    </div>
  </div>

  <div class="container">

    <!-- HERO -->
    <div class="hero">
      <div class="card cardPad">
        <h1 class="hTitle" style="font-size:34px;margin-bottom:8px;">Institute Dashboard</h1>
        <p class="hSub" style="margin-top:0;">
          Teachers browse karo, invite bhejo, job applications me resume + PDF view/download karo.
        </p>

        <div class="kpis">
          <div class="kpi">
            <b id="teacherBadge">‚Äî</b>
            <span>Teachers Loaded</span>
          </div>
          <div class="kpi">
            <b id="appBadge">‚Äî</b>
            <span>Applications</span>
          </div>
          <div class="kpi">
            <b id="lastAction">Ready</b>
            <span>Status</span>
          </div>
        </div>
      </div>
    </div>

    <!-- BROWSE TEACHERS -->
    <div class="card cardPad">
      <div class="sectionTitle">üë©‚Äçüè´ Browse Teachers</div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn" onclick="browseTeachers()">Load Teachers</button>
      </div>

      <div id="teachers" class="list" style="margin-top:12px;"></div>
    </div>

    <!-- APPLICATIONS -->
    <div class="card cardPad" style="margin-top:14px;">
      <div class="sectionTitle">üì• Job Applications</div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn" onclick="loadApplications()">View Applications</button>
      </div>

      <div id="applications" class="list" style="margin-top:12px;"></div>
    </div>

    <div class="footer">
      <a class="smallLink" href="index.html">Home</a> ¬∑
      <a class="smallLink" href="jobs.html">Jobs</a> ¬∑
      <a class="smallLink" href="interview/index.html">Interview</a>
    </div>

  </div>

<script>
const BASE_URL = "https://express-hello-world-uh96.onrender.com";
const uid = localStorage.getItem("uid");

/* ================= LOGOUT ================= */
function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}

/* ================= UI HELPERS ================= */
function setLastAction(txt){ document.getElementById("lastAction").innerText = txt; }

function escapeHtml(str) {
  return String(str || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ================= HELPER: BUILD RESUME LINK ================= */
function buildResumeLink(resumeUrl) {
  if (!resumeUrl) return null;
  if (resumeUrl.startsWith("http")) return resumeUrl;
  if (resumeUrl.startsWith("/")) return `${BASE_URL}${resumeUrl}`;
  return `${BASE_URL}/${resumeUrl}`;
}

/* ================= BROWSE TEACHERS ================= */
async function browseTeachers() {
  const box = document.getElementById("teachers");
  box.innerHTML = `<div class="meta">Loading teachers...</div>`;
  setLastAction("Loading teachers‚Ä¶");

  try {
    const res = await fetch(`${BASE_URL}/api/teacher/browse`);
    const data = await res.json();

    const list = (data && data.teachers) ? data.teachers : [];
    document.getElementById("teacherBadge").innerText = list.length;

    if (!list.length) {
      box.innerHTML = `<div class="meta">No teachers found</div>`;
      setLastAction("No teachers");
      return;
    }

    box.innerHTML = "";
    list.forEach(t => {
      const div = document.createElement("div");
      div.className = "item";

      div.innerHTML = `
        <div>
          <div style="font-weight:800;">${escapeHtml(t.name)}</div>
          <div class="meta">${escapeHtml(t.subject)} ¬∑ ${escapeHtml(t.city || "‚Äî")} ¬∑ ${Number(t.experience || 0)} yrs</div>
          <div class="meta">
            <a class="smallLink" href="teacher-resume-view.htm?uid=${encodeURIComponent(t.uid)}" target="_blank">
              View Resume Page
            </a>
          </div>
        </div>

        <div>
          <button class="btn" onclick="sendInvite('${encodeURIComponent(t.uid)}')">Send Invite</button>
        </div>
      `;

      box.appendChild(div);
    });

    setLastAction("Teachers loaded");
  } catch (e) {
    console.error(e);
    box.innerHTML = `<div class="meta">Failed to load teachers</div>`;
    document.getElementById("teacherBadge").innerText = "0";
    setLastAction("Error");
  }
}

/* ================= SEND INVITE ================= */
async function sendInvite(teacherUid) {
  setLastAction("Sending invite‚Ä¶");

  try {
    const res = await fetch(`${BASE_URL}/api/invite/create`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        fromType: "institute",
        fromUid: uid,
        toType: "teacher",
        toUid: decodeURIComponent(teacherUid)
      })
    });

    const data = await res.json();
    alert(data.message || "Invite sent");
    setLastAction("Invite sent");
  } catch (e) {
    console.error(e);
    alert("Invite failed");
    setLastAction("Invite failed");
  }
}

/* ================= LOAD JOB APPLICATIONS ================= */
async function loadApplications() {
  const box = document.getElementById("applications");
  box.innerHTML = `<div class="meta">Loading applications...</div>`;
  setLastAction("Loading applications‚Ä¶");

  try {
    const res = await fetch(`${BASE_URL}/api/job/applications/institute/${uid}`);
    const data = await res.json();

    const apps = (data && data.applications) ? data.applications : [];
    document.getElementById("appBadge").innerText = apps.length;

    if (!apps.length) {
      box.innerHTML = `<div class="meta">No applications yet</div>`;
      setLastAction("No applications");
      return;
    }

    box.innerHTML = "";
    apps.forEach(app => {
      const div = document.createElement("div");
      div.className = "item";

      const resume = app.resumeSnapshot || {};
      const t = app.teacher || null;

      const teacherName = t ? `${t.name} (${app.teacherUid})` : app.teacherUid;
      const resumePdf = t ? buildResumeLink(t.resumeUrl) : null;

      div.innerHTML = `
        <div style="width:100%;">
          <div style="font-weight:800;">Teacher: ${escapeHtml(teacherName)}</div>
          <div class="meta">Status: ${escapeHtml(app.status || "applied")}</div>

          <div class="kpi" style="margin-top:10px;">
            <b>Resume Snapshot</b>
            <span>
              Education: ${escapeHtml(resume.education || "‚Äî")}<br>
              Skills: ${escapeHtml((resume.skills || []).join(", ") || "‚Äî")}<br>
              About: ${escapeHtml(resume.about || "‚Äî")}
            </span>
          </div>

          <div class="meta" style="margin-top:10px;">
            ${
              resumePdf
                ? `‚úÖ <b>Resume PDF:</b>
                   <a class="smallLink" href="${resumePdf}" target="_blank">View</a>
                   ¬∑
                   <a class="smallLink" href="${resumePdf}" download>Download</a>`
                : `‚ùå <b>Resume PDF:</b> Not uploaded`
            }
          </div>

          ${
            (app.status === "pending" || app.status === "applied" || !app.status)
              ? `<div style="margin-top:10px;">
                   <button class="btn" onclick="shortlist('${app._id}')">Shortlist</button>
                 </div>`
              : ""
          }
        </div>
      `;

      box.appendChild(div);
    });

    setLastAction("Applications loaded");
  } catch (e) {
    console.error(e);
    box.innerHTML = `<div class="meta">Failed to load applications</div>`;
    document.getElementById("appBadge").innerText = "0";
    setLastAction("Error");
  }
}

/* ================= SHORTLIST ================= */
async function shortlist(id) {
  setLastAction("Shortlisting‚Ä¶");

  await fetch(`${BASE_URL}/api/job/application/shortlist/${id}`, {
    method: "POST"
  });

  alert("Applicant shortlisted");
  setLastAction("Shortlisted");
  loadApplications();
}
</script>

</body>
</html>
