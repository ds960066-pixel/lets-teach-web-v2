<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Institute Dashboard | Lets Teach</title>

  <!-- ‚úÖ Same Professional Theme -->
  <link rel="stylesheet" href="styles.css" />
</head>

<body>

  <!-- AUTH + ROLE GUARD -->
  <script>
    if (!localStorage.uid || localStorage.role !== "institute") {
      window.location.href = "login.html";
    }
  </script>

  <!-- NAV -->
  <div class="nav">
    <div class="container navInner">
      <a class="brand" href="index.html">
        <div class="logo"></div>
        <div>Lets Teach</div>
      </a>

      <div class="navLinks">
        <a class="pill" href="jobs.html">Jobs</a>
        <a class="pill" href="interview/index.html">Interview Preps</a>
        <a class="pill" href="#" onclick="logout();return false;">Logout</a>
      </div>
    </div>
  </div>

  <div class="container">

    <!-- HERO -->
    <div class="hero">
      <div class="card cardPad">
        <h1 class="hTitle" style="font-size:34px;margin-bottom:8px;">Institute Dashboard</h1>
        <p class="hSub" style="margin-top:0;">
          Teachers browse karo, invite bhejo, jobs post karo, aur applications me resume + PDF view/download karo.
        </p>

        <div class="kpis">
          <div class="kpi">
            <b id="teacherBadge">‚Äî</b>
            <span>Teachers Loaded</span>
          </div>
          <div class="kpi">
            <b id="jobBadge">‚Äî</b>
            <span>My Jobs</span>
          </div>
          <div class="kpi">
            <b id="appBadge">‚Äî</b>
            <span>Applications</span>
          </div>
        </div>

        <hr class="sep">

        <div class="kpi">
          <b id="lastAction">Ready</b>
          <span>Status</span>
        </div>
      </div>
    </div>

    <!-- ‚úÖ POST A JOB (PRO) -->
    <div class="card cardPad">
      <div class="sectionTitle">üìå Post a Job</div>
      <div class="meta" style="margin-top:-4px;">
        Note: ‚ÄúSubjects Needed‚Äù profile alag hai. Job page me jobs tabhi dikhenge jab yahan se job post hoga.
      </div>

      <hr class="sep">

      <div class="grid2">
        <div>
          <label class="meta">Job Title <b style="color:#e5e7eb">*</b></label>
          <input class="input" id="jobTitle" placeholder="e.g. English Teacher (Class 6-10)" />
        </div>

        <div>
          <label class="meta">Subject <b style="color:#e5e7eb">*</b></label>
          <input class="input" id="jobSubject" placeholder="e.g. English" />
        </div>

        <div>
          <label class="meta">City <b style="color:#e5e7eb">*</b></label>
          <input class="input" id="jobCity" placeholder="e.g. Patna" />
        </div>

        <div>
          <label class="meta">Role</label>
          <select class="input" id="jobRole">
            <option value="both">Both</option>
            <option value="part-time">Part-time</option>
            <option value="full-time">Full-time</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label class="meta">Salary (optional)</label>
        <input class="input" id="jobSalary" placeholder="e.g. 20,000 - 30,000 / month" />
      </div>

      <div style="margin-top:10px;">
        <label class="meta">Description (optional)</label>
        <textarea class="input" id="jobDesc" rows="4" placeholder="Job details, class, timings, requirements..."></textarea>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
        <button class="btn" onclick="createJob()">Create Job</button>
        <button class="pill" onclick="clearJobForm()">Clear</button>
        <button class="pill" onclick="loadMyJobs()">Refresh My Jobs</button>
      </div>

      <div id="jobMsg" class="meta" style="margin-top:10px;"></div>
    </div>

    <!-- ‚úÖ MY JOBS LIST -->
    <div class="card cardPad" style="margin-top:14px;">
      <div class="sectionTitle">üóÇÔ∏è My Posted Jobs</div>
      <div class="meta">Open/Close manage karo. Posted date automatic hai.</div>

      <hr class="sep">

      <div id="myJobs" class="list"></div>
    </div>

    <!-- BROWSE TEACHERS -->
    <div class="card cardPad" style="margin-top:14px;">
      <div class="sectionTitle">üë©‚Äçüè´ Browse Teachers</div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn" onclick="browseTeachers()">Load Teachers</button>
      </div>

      <div id="teachers" class="list" style="margin-top:12px;"></div>
    </div>

    <!-- APPLICATIONS -->
    <div class="card cardPad" style="margin-top:14px;">
      <div class="sectionTitle">üì• Job Applications</div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn" onclick="loadApplications()">View Applications</button>
      </div>

      <div id="applications" class="list" style="margin-top:12px;"></div>
    </div>

    <div class="footer">
      <a class="smallLink" href="index.html">Home</a> ¬∑
      <a class="smallLink" href="jobs.html">Jobs</a> ¬∑
      <a class="smallLink" href="interview/index.html">Interview</a>
    </div>

  </div>

<script>
const BASE_URL = "https://express-hello-world-uh96.onrender.com";
const uid = localStorage.getItem("uid");

/* ================= LOGOUT ================= */
function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}

/* ================= UI HELPERS ================= */
function setLastAction(txt){ document.getElementById("lastAction").innerText = txt; }

function escapeHtml(str) {
  return String(str || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function fmtDate(iso) {
  if (!iso) return "‚Äî";
  const d = new Date(iso);
  if (isNaN(d.getTime())) return "‚Äî";
  return d.toLocaleString(); // simple + best for now
}

/* ================= HELPER: BUILD RESUME LINK ================= */
function buildResumeLink(resumeUrl) {
  if (!resumeUrl) return null;
  if (resumeUrl.startsWith("http")) return resumeUrl;
  if (resumeUrl.startsWith("/")) return `${BASE_URL}${resumeUrl}`;
  return `${BASE_URL}/${resumeUrl}`;
}

/* ================= JOB: CLEAR FORM ================= */
function clearJobForm(){
  document.getElementById("jobTitle").value = "";
  document.getElementById("jobSubject").value = "";
  document.getElementById("jobCity").value = "";
  document.getElementById("jobRole").value = "both";
  document.getElementById("jobSalary").value = "";
  document.getElementById("jobDesc").value = "";
  document.getElementById("jobMsg").innerText = "";
  setLastAction("Form cleared");
}

/* ================= JOB: CREATE ================= */
async function createJob() {
  const title = document.getElementById("jobTitle").value.trim();
  const subject = document.getElementById("jobSubject").value.trim();
  const city = document.getElementById("jobCity").value.trim();
  const role = document.getElementById("jobRole").value;
  const salary = document.getElementById("jobSalary").value.trim();
  const description = document.getElementById("jobDesc").value.trim();

  if (!title || !subject || !city) {
    document.getElementById("jobMsg").innerText = "‚ùå Title, Subject, City required";
    setLastAction("Job create failed");
    return;
  }

  document.getElementById("jobMsg").innerText = "Posting job...";
  setLastAction("Posting job‚Ä¶");

  try {
    const res = await fetch(`${BASE_URL}/api/job/create`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        instituteUid: uid,
        title,
        subject,
        city,
        role,
        salary,
        description
      })
    });

    const data = await res.json();

    if (!data.success) {
      document.getElementById("jobMsg").innerText = `‚ùå ${data.message || "Failed"}`;
      setLastAction("Job post failed");
      return;
    }

    document.getElementById("jobMsg").innerText = "‚úÖ Job posted successfully";
    setLastAction("Job posted");
    clearJobForm();
    loadMyJobs();
  } catch (e) {
    console.error(e);
    document.getElementById("jobMsg").innerText = "‚ùå Server error";
    setLastAction("Error");
  }
}

/* ================= JOB: LOAD MY JOBS ================= */
async function loadMyJobs() {
  const box = document.getElementById("myJobs");
  box.innerHTML = `<div class="meta">Loading jobs...</div>`;
  setLastAction("Loading my jobs‚Ä¶");

  try {
    const res = await fetch(`${BASE_URL}/api/job/institute/${encodeURIComponent(uid)}`);
    const data = await res.json();

    const jobs = (data && data.jobs) ? data.jobs : [];
    document.getElementById("jobBadge").innerText = jobs.length;

    if (!jobs.length) {
      box.innerHTML = `<div class="meta">No jobs posted yet</div>`;
      setLastAction("No jobs");
      return;
    }

    box.innerHTML = "";
    jobs.forEach(j => {
      const postedOn = fmtDate(j.postedAt || j.createdAt);
      const status = j.status || "open";

      const badgeStyle = status === "open"
        ? `border-color:rgba(34,197,94,.32);background:rgba(34,197,94,.10);color:#bbf7d0;`
        : `border-color:rgba(148,163,184,.35);background:rgba(148,163,184,.10);color:#e5e7eb;`;

      const div = document.createElement("div");
      div.className = "item";

      div.innerHTML = `
        <div style="max-width:70%;">
          <div style="font-weight:800;">${escapeHtml(j.title || "Job")}</div>
          <div class="meta">
            ${escapeHtml(j.subject || "‚Äî")} ¬∑ ${escapeHtml(j.city || "‚Äî")} ¬∑ ${escapeHtml(j.role || "both")}
          </div>
          <div class="meta">
            Salary: ${escapeHtml(j.salary || "Negotiable")}
          </div>
          <div class="meta">
            Posted: <b>${escapeHtml(postedOn)}</b>
          </div>
          ${
            j.description
              ? `<div class="meta" style="margin-top:6px;">${escapeHtml(j.description)}</div>`
              : ""
          }
        </div>

        <div style="display:flex;flex-direction:column;gap:10px;align-items:flex-end;">
          <span class="badge" style="${badgeStyle}">${escapeHtml(status.toUpperCase())}</span>
          ${
            status === "open"
              ? `<button class="btn" onclick="closeJob('${j._id}')">Close Job</button>`
              : `<span class="meta">Closed</span>`
          }
        </div>
      `;

      box.appendChild(div);
    });

    setLastAction("Jobs loaded");
  } catch (e) {
    console.error(e);
    document.getElementById("jobBadge").innerText = "0";
    box.innerHTML = `<div class="meta">Failed to load jobs</div>`;
    setLastAction("Error");
  }
}

/* ================= JOB: CLOSE ================= */
async function closeJob(jobId) {
  if (!confirm("Close this job?")) return;

  setLastAction("Closing job‚Ä¶");

  try {
    const res = await fetch(`${BASE_URL}/api/job/close/${jobId}`, { method: "POST" });
    const data = await res.json();

    if (!data.success) {
      alert(data.message || "Failed to close");
      setLastAction("Close failed");
      return;
    }

    alert("Job closed");
    setLastAction("Job closed");
    loadMyJobs();
  } catch (e) {
    console.error(e);
    alert("Server error");
    setLastAction("Error");
  }
}

/* ================= BROWSE TEACHERS ================= */
async function browseTeachers() {
  const box = document.getElementById("teachers");
  box.innerHTML = `<div class="meta">Loading teachers...</div>`;
  setLastAction("Loading teachers‚Ä¶");

  try {
    const res = await fetch(`${BASE_URL}/api/teacher/browse`);
    const data = await res.json();

    const list = (data && data.teachers) ? data.teachers : [];
    document.getElementById("teacherBadge").innerText = list.length;

    if (!list.length) {
      box.innerHTML = `<div class="meta">No teachers found</div>`;
      setLastAction("No teachers");
      return;
    }

    box.innerHTML = "";
    list.forEach(t => {
      const div = document.createElement("div");
      div.className = "item";

      div.innerHTML = `
        <div>
          <div style="font-weight:800;">${escapeHtml(t.name)}</div>
          <div class="meta">${escapeHtml(t.subject)} ¬∑ ${escapeHtml(t.city || "‚Äî")} ¬∑ ${Number(t.experience || 0)} yrs</div>
          <div class="meta">
            <a class="smallLink" href="teacher-resume-view.html?uid=${encodeURIComponent(t.uid)}" target="_blank">
              View Resume Page
            </a>
          </div>
        </div>

        <div>
          <button class="btn" onclick="sendInvite('${encodeURIComponent(t.uid)}')">Send Invite</button>
        </div>
      `;

      box.appendChild(div);
    });

    setLastAction("Teachers loaded");
  } catch (e) {
    console.error(e);
    box.innerHTML = `<div class="meta">Failed to load teachers</div>`;
    document.getElementById("teacherBadge").innerText = "0";
    setLastAction("Error");
  }
}

/* ================= SEND INVITE ================= */
async function sendInvite(teacherUid) {
  setLastAction("Sending invite‚Ä¶");

  try {
    const res = await fetch(`${BASE_URL}/api/invite/create`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        fromType: "institute",
        fromUid: uid,
        toType: "teacher",
        toUid: decodeURIComponent(teacherUid)
      })
    });

    const data = await res.json();
    alert(data.message || "Invite sent");
    setLastAction("Invite sent");
  } catch (e) {
    console.error(e);
    alert("Invite failed");
    setLastAction("Invite failed");
  }
}

/* ================= LOAD JOB APPLICATIONS ================= */
async function loadApplications() {
  const box = document.getElementById("applications");
  box.innerHTML = `<div class="meta">Loading applications...</div>`;
  setLastAction("Loading applications‚Ä¶");

  try {
    const res = await fetch(`${BASE_URL}/api/job/applications/institute/${uid}`);
    const data = await res.json();

    const apps = (data && data.applications) ? data.applications : [];
    document.getElementById("appBadge").innerText = apps.length;

    if (!apps.length) {
      box.innerHTML = `<div class="meta">No applications yet</div>`;
      setLastAction("No applications");
      return;
    }

    box.innerHTML = "";
    apps.forEach(app => {
      const div = document.createElement("div");
      div.className = "item";

      const resume = app.resumeSnapshot || {};
      const t = app.teacher || null;

      const teacherName = t ? `${t.name} (${app.teacherUid})` : app.teacherUid;
      const resumePdf = t ? buildResumeLink(t.resumeUrl) : null;

      div.innerHTML = `
        <div style="width:100%;">
          <div style="font-weight:800;">Teacher: ${escapeHtml(teacherName)}</div>
          <div class="meta">Status: ${escapeHtml(app.status || "applied")}</div>

          <div class="kpi" style="margin-top:10px;">
            <b>Resume Snapshot</b>
            <span>
              Education: ${escapeHtml(resume.education || "‚Äî")}<br>
              Skills: ${escapeHtml((resume.skills || []).join(", ") || "‚Äî")}<br>
              About: ${escapeHtml(resume.about || "‚Äî")}
            </span>
          </div>

          <div class="meta" style="margin-top:10px;">
            ${
              resumePdf
                ? `‚úÖ <b>Resume PDF:</b>
                   <a class="smallLink" href="${resumePdf}" target="_blank">View</a>
                   ¬∑
                   <a class="smallLink" href="${resumePdf}" download>Download</a>`
                : `‚ùå <b>Resume PDF:</b> Not uploaded`
            }
          </div>

          ${
            (app.status === "pending" || app.status === "applied" || !app.status)
              ? `<div style="margin-top:10px;">
                   <button class="btn" onclick="shortlist('${app._id}')">Shortlist</button>
                 </div>`
              : ""
          }
        </div>
      `;

      box.appendChild(div);
    });

    setLastAction("Applications loaded");
  } catch (e) {
    console.error(e);
    box.innerHTML = `<div class="meta">Failed to load applications</div>`;
    document.getElementById("appBadge").innerText = "0";
    setLastAction("Error");
  }
}

/* ================= SHORTLIST ================= */
async function shortlist(id) {
  setLastAction("Shortlisting‚Ä¶");

  await fetch(`${BASE_URL}/api/job/application/shortlist/${id}`, {
    method: "POST"
  });

  alert("Applicant shortlisted");
  setLastAction("Shortlisted");
  loadApplications();
}

/* ================= INIT ================= */
loadMyJobs();
</script>

</body>
</html>
