<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Realtime Chat Test | Lets Teach</title>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <style>
    body { font-family: Arial; padding: 20px; background:#f5f5f5; }
    .card{background:#fff;border-radius:8px;padding:14px;max-width:820px;margin:auto;}
    #chat {
      border: 1px solid #ddd;
      height: 320px;
      overflow-y: auto;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      background:#fafafa;
      display:flex;flex-direction:column;gap:8px;
    }
    .me {
      align-self:flex-end;
      background:#dcf8c6;
      padding:8px 10px;
      border-radius:10px;
      max-width:75%;
    }
    .other {
      align-self:flex-start;
      background:#e9ecef;
      padding:8px 10px;
      border-radius:10px;
      max-width:75%;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input{padding:10px;border:1px solid #ddd;border-radius:8px;min-width:240px}
    button{padding:10px 14px;border:0;border-radius:8px;background:#2e86de;color:#fff;cursor:pointer}
    button:hover{filter:brightness(0.95)}
    small{color:#666}
  </style>
</head>

<body>
  <div class="card">
    <h2>Realtime Chat Test</h2>

    <div class="row">
      <small id="info">Loading...</small>
    </div>

    <div id="chat"></div>

    <div class="row">
      <input id="msg" placeholder="Type message" />
      <button onclick="send()">Send</button>
    </div>

    <hr>
    <small>
      Usage (local): <b>?me=user1&other=user2&roomId=user1_user2&server=local</b><br>
      Usage (render): <b>?me=user1&other=user2&roomId=user1_user2&server=prod</b>
    </small>
  </div>

<script>
  const params = new URLSearchParams(window.location.search);

  // ✅ required-ish values
  const roomId = params.get("roomId") || "room1";
  const me = params.get("me") || "user1";
  const other = params.get("other") || "user2";

  // ✅ server switch
  const serverMode = (params.get("server") || "local").toLowerCase();
  const PROD_URL = "https://express-hello-world-uh96.onrender.com";
  const LOCAL_URL = "http://localhost:5000";
  const SOCKET_URL = serverMode === "prod" ? PROD_URL : LOCAL_URL;

  document.getElementById("info").innerText =
    `Server: ${SOCKET_URL} | Room: ${roomId} | Me: ${me} | Other: ${other}`;

  const socket = io(SOCKET_URL);

  socket.on("connect", () => {
    socket.emit("joinRoom", roomId);
  });

  socket.on("receiveMessage", (data) => {
    const div = document.createElement("div");
    div.className = (data.senderUid === me) ? "me" : "other";
    div.innerText = `${data.senderUid}: ${data.text}`;
    document.getElementById("chat").appendChild(div);
    document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
  });

  function send() {
    const input = document.getElementById("msg");
    const text = input.value.trim();
    if (!text) return;

    // ✅ show instantly
    const div = document.createElement("div");
    div.className = "me";
    div.innerText = `${me}: ${text}`;
    document.getElementById("chat").appendChild(div);

    // ✅ IMPORTANT: include receiverUid + roomId (server expects)
    socket.emit("sendMessage", {
      senderUid: me,
      receiverUid: other,
      text,
      roomId
    });

    input.value = "";
    input.focus();
    document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
  }

  document.getElementById("msg").addEventListener("keydown", (e) => {
    if (e.key === "Enter") send();
  });
</script>

</body>
</html>
